function render(e,t){let n=document.createElement(e);return t.attr&&Object.keys(t.attr).forEach(function(e){n.setAttribute(e,t.attr[e])}),t.style&&Object.keys(t.style).forEach(e=>{n.style[e]=t.style[e]}),t.textContent&&(n.textContent=t.textContent),t.id&&(n.id=t.id),t.class&&(n.className=t.class),t.handlers&&Object.keys(t.handlers).length&&Object.keys(t.handlers).forEach(e=>{n.addEventListener(e,t.handlers[e])}),t.appendTo&&document.querySelector(t.appendTo).append(n),t.appendIn&&Object.keys(t.appendIn).forEach(function(e){n.appendChild(t.appendIn[e])}),t.prepend&&document.querySelector(t.prepend).prepend(n),n}function QS(e){return"string"==typeof e?document.querySelector(e):e}function QSA(e){return"string"==typeof e?document.querySelectorAll(e):e}function ID(e){return"string"==typeof e?document.getElementById(e):e}const convert=ID("convert"),save_pdf=ID("save_pdf"),save_png=ID("save_png"),editor=ID("editor_block"),generate_dom=ID("generate_dom"),generate_img=ID("generate_img"),setting_btn=ID("setting_btn"),freePages=4;let pdf=new jsPDF("p","mm","a4",!0),zip=new JSZip;const bool=getCookie("register")||!1;bool&&(editor.innerHTML="<p>Добро пожаловать в Handwritten</p>",ID("set_btn").style.display="block",ID("file_select").style.display="block",ID("user_btn").style.display="none");const random=()=>1e3+Math.floor(1001*Math.random()),fadeOut=(e,t)=>{const n=QS(e);n.style.opacity=1,setTimeout(()=>{(function e(){(n.style.opacity-=.1)<0?n.style.display="none":requestAnimationFrame(e)})()},t)},fadeIn=(e,t,n)=>{const s=QS(e);s.style.opacity=0,s.style.display=t||"block",setTimeout(()=>{(function e(){var t=parseFloat(s.style.opacity);(t+=.1)>1||(s.style.opacity=t,requestAnimationFrame(e))})()},n)},renderColumn=()=>{getCookie("page")?editor.dbabych_columnize({width:QS(`.${getCookie("page")}_size`).offsetWidth,height:QS(`.${getCookie("page")}_size`).offsetHeight,done_func:()=>{console.log("Page added!"),generate_img.innerHTML=null},target:generate_dom}):editor.dbabych_columnize({width:QS(`.${ID("page-select").value}_size`).offsetWidth,height:QS(`.${ID("page-select").value}_size`).offsetHeight,done_func:()=>{console.log("Page added!"),generate_img.innerHTML=null},target:generate_dom})},renderImg=(e,t)=>{setTimeout(()=>{e.style.display="inline-block",domtoimage.toPng(e).then(n=>{render("div",{appendIn:[render("a",{attr:{"data-type":"image",class:"uk-inline",href:n,"data-caption":`Страница ${t+1}`},appendIn:[render("img",{attr:{src:n}})]})],appendTo:"#generate_img"}),e.style.display="none"}).catch(e=>{UIkit.notification({message:"<span uk-icon='icon: check'></span> Ошибка",pos:"bottom-right",status:"danger"}),console.log(e)})},1e3*t)},parseDocxFile=e=>{fadeIn(".full","flex",500),editor.innerHTML="";const t=e.files||[];if(!t.length)return;const n=t[0],s=n.name.split(".")[n.name.split(".").length-1].toLowerCase();if("docx"===s){let e=new FileReader;e.onload=(()=>{let t=e.result;mammoth.extractRawText({arrayBuffer:t}).then(e=>{editor.innerText=e.value,fadeOut(".full",1e3)})}),e.readAsArrayBuffer(n)}},parseTxtFile=e=>{fadeIn(".full","flex",500),editor.innerHTML="";const t=e.files||[];if(!t.length)return;const n=t[0],s=n.name.split(".")[n.name.split(".").length-1].toLowerCase();if("txt"===s){let e=new FileReader;e.onload=(e=>{editor.innerText=e.target.result,fadeOut(".full",1e3)}),e.readAsText(n,"CP1251")}};document.getElementById("parse-docx").addEventListener("change",function(){parseDocxFile(this)}),document.getElementById("parse-txt").addEventListener("change",function(){parseTxtFile(this)}),convert.addEventListener("click",function(){let e;if(renderColumn(),e=getCookie("page")?QSA(`.${getCookie("page")}`):QSA(`.${ID("page-select").value}`),bool)e.forEach((e,t)=>{renderImg(e,t)});else if(e.length<=freePages)e.forEach((e,t)=>{renderImg(e,t)});else for(let t=0;t<freePages;t++)renderImg(e[t],t);fadeIn(".full","flex",500),fadeOut(".full",1e3*e.length),UIkit.notification({message:"<span uk-icon='icon: check'></span> Выполнено",pos:"bottom-right",status:"success"}),pdf=new jsPDF("p","mm","a4",!0),zip=new JSZip}),save_pdf.addEventListener("click",()=>{let e;e=getCookie("page")?QSA(`.${getCookie("page")}`):QSA(`.${ID("page-select").value}`),e.length>0&&fadeIn(".full","flex",500),setTimeout(()=>{e.length>0&&(QSA("#generate_img img").forEach((e,t)=>{pdf.addImage(e.src,"PNG",0,0,210,297,t,"FAST"),pdf.addPage()}),fadeOut(".full",500),UIkit.notification({message:"<span uk-icon='icon: check'></span> Выполнено",pos:"bottom-right",status:"success"}),pdf.deletePage(pdf.internal.getNumberOfPages()),pdf.save(`handwritten${random()}.pdf`))},1e3)}),save_png.addEventListener("click",()=>{let e;e=getCookie("page")?QSA(`.${getCookie("page")}`):QSA(`.${ID("page-select").value}`),UIkit.notification({message:"<span uk-icon='icon: check'></span> Выполнено",pos:"bottom-right",status:"success"}),e.length>1?(QSA("#generate_img img").forEach((e,t)=>{zip.file(`Страница ${t+1}.png`,`${e.src.slice(22)}`,{base64:!0})}),zip.generateAsync({type:"blob"}).then(function(e){saveAs(e,`handwritten${random()}.zip`)})):e.forEach((e,t)=>{e.style.display="inline-block",domtoimage.toBlob(e).then(function(t){window.saveAs(t,`handwritten${random()}.png`),e.style.display="none"})})}),setting_btn.addEventListener("click",()=>{setCookie("font_family",ID("font-select").value,365e3),setCookie("font_size",ID("font-size-select").value,365e3),setCookie("page",ID("page-select").value,365e3),ID("setting_close").click(),convert.click()}),document.addEventListener("DOMContentLoaded",()=>{convert.click(),getCookie("font_family")&&(ID("font-select").value=getCookie("font_family")),getCookie("font_size")&&(ID("font-size-select").value=getCookie("font_size")),getCookie("page")&&(ID("page-select").value=getCookie("page"))}),window.onload=(async()=>{ if ("serviceWorker" in navigator) try {
    await navigator.serviceWorker.register("./sw.js")
  } catch (e) {
    console.error("Service worker register Error", e)
  }});const Regex=/^[a-zA-Z0-9_ ]+$/,emailRegex=/^(([a-zA-Z0-9_.]+(\.[a-zA-Z0-9_.]+)*)|(\".+\"))@(([a-zA-Z0-9_.]+\.)+[a-zA-Z]{2,})$/i,passwordRegex=/^[a-zA-Z0-9_]+$/,validate=(e,t,n,s,i,a=null,o=null)=>{const r=document.getElementById(t),l=()=>{r.previousElementSibling.style.color="#333",r.previousElementSibling.innerHTML="",r.classList.remove("uk-form-danger"),r.classList.add("uk-form-success")},d=e=>{r.previousElementSibling.style.color="#f0506e",r.previousElementSibling.innerHTML=e,r.classList.remove("uk-form-success"),r.classList.add("uk-form-danger")},c=()=>{QSA(`${e} .uk-form-success`).length==QSA(`${e} .uk-input`).length?ID(i).removeAttribute("disabled"):ID(i).setAttribute("disabled","")},g=()=>{QSA(`${e} .uk-input`)[3].classList.contains("uk-form-success")&&QSA(`${e} .uk-form-success`).length>1?ID(i).removeAttribute("disabled"):ID(i).setAttribute("disabled","")};switch(n){case"name":r.addEventListener(s,function(){this.value.length<4||!this.value.match(Regex)?d("Введите не менее 4 символов [A-z_0-9]"):l(),c()});break;case"email":r.addEventListener(s,function(){this.value.length<4||!this.value.match(emailRegex)?d("Введите действительный адрес"):l(),c()});break;case"password":r.addEventListener(s,function(){this.value.length<6||!this.value.match(passwordRegex)?d("Введите не менее 6 символов [A-z_0-9]"):l(),c()});break;case"passwordAnd":r.addEventListener(s,function(){this.value.length<6||!this.value.match(passwordRegex)?d("Введите не менее 6 символов [A-z_0-9]"):l(),this.value!=ID(o).value?(ID(o).previousElementSibling.style.color="#f0506e",ID(o).previousElementSibling.innerHTML="Введите тот же пароль, что и выше",ID(o).classList.remove("uk-form-success"),ID(o).classList.add("uk-form-danger")):(ID(o).previousElementSibling.style.color="#333",ID(o).previousElementSibling.innerHTML="",ID(o).classList.remove("uk-form-danger"),ID(o).classList.add("uk-form-success")),c()});break;case"passwordConfirm":r.addEventListener(s,function(){this.value==ID(a).value&&this.value.match(passwordRegex)?l():d("Введите тот же пароль, что и выше"),c()})}switch(n){case"settingName":r.addEventListener(s,function(){this.value.length<4||!this.value.match(Regex)?d("Введите не менее 4 символов [A-z_0-9]"):l(),g()});break;case"settingEmail":r.addEventListener(s,function(){this.value.length<4||!this.value.match(emailRegex)?d("Введите действительный адрес"):l(),g()});break;case"settingPassword":r.addEventListener(s,function(){this.value.length<6||!this.value.match(passwordRegex)?d("Введите не менее 6 символов [A-z_0-9]"):l(),g()})}};validate("#register_form","register_email","email","input","register_btn"),validate("#register_form","register_password","passwordAnd","input","register_btn",this,"register_password_confirm"),validate("#register_form","register_password_confirm","passwordConfirm","input","register_btn","register_password"),validate("#sign_in_form","sign_in_email","email","input","sign_in_btn"),validate("#sign_in_form","sign_in_password","password","input","sign_in_btn"),validate("#forgot_password_form","forgot_password_email","email","input","forgot_password_btn");const deleteCookie=(e,t)=>{getCookie(e)&&(document.cookie=`${e}=;path=${t};expires=Thu, 01 Jan 1970 00:00:01 GMT"`)},successNotification=e=>{UIkit.notification({message:e,pos:"top-center",status:"success"})},dangerNotification=e=>{UIkit.notification({message:e,pos:"top-center",status:"danger"})};let firebaseConfig={apiKey:"AIzaSyCzIo2VslfMJ3z1cKRBoqvDEX9DX5Cyzc8",authDomain:"handwritten-ml.firebaseapp.com",projectId:"handwritten-ml",storageBucket:"handwritten-ml.appspot.com",messagingSenderId:"198827978374",appId:"1:198827978374:web:9c565788b55d57d00fab07"};firebase.initializeApp(firebaseConfig);const auth=firebase.auth(),signUpForm=document.getElementById("register_form"),signInForm=document.getElementById("sign_in_form"),sign_out=document.getElementById("sign_out"),updatePasswordForm=document.getElementById("forgot_password_form");signUpForm.addEventListener("submit",e=>{e.preventDefault();const t=signUpForm.register_email.value,n=signUpForm.register_password.value;auth.createUserWithEmailAndPassword(t,n).then(()=>{successNotification("Выполнено"),setCookie("register","true",365e3),location.reload()}).catch(e=>{"auth/email-already-in-use"===e.code&&dangerNotification("Адрес электронной почты уже используется другой учетной записью!")})}),signInForm.addEventListener("submit",e=>{e.preventDefault();const t=signInForm.sign_in_email.value,n=signInForm.sign_in_password.value;auth.signInWithEmailAndPassword(t,n).then(()=>{successNotification("Выполнено"),setCookie("register","true",365e3),location.reload()}).catch(function(e){(e.code="auth/user-not-found")&&dangerNotification("Нет записи пользователя, или пароль недействителен!")})}),updatePasswordForm.addEventListener("submit",e=>{e.preventDefault();const t=updatePasswordForm.forgot_password_email.value;auth.sendPasswordResetEmail(t).then(function(){successNotification(`Мы отправили ссылку на адрес ${t}`),setTimeout(()=>{document.getElementById("sign_in_nav").click()},1e3)}).catch(function(e){(e.code="auth/user-not-found")&&dangerNotification("Нет записи пользователя, соответствующей этому идентификатору!")})}),sign_out.addEventListener("click",e=>{e.preventDefault(),auth.signOut().then(()=>{successNotification("Выполнено"),deleteCookie("register","/"),location.reload()}).catch(dangerNotification("Ошибка"))});